<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <!-- Enable Brotli compression -->
    <staticContent>
      <!-- Remove default .br mapping if exists -->
      <remove fileExtension=".br" />
      <!-- Add Brotli compressed files with correct MIME type -->
      <mimeMap fileExtension=".br" mimeType="application/octet-stream" />
      
      <!-- WASM files -->
      <remove fileExtension=".wasm" />
      <mimeMap fileExtension=".wasm" mimeType="application/wasm" />
      
      <!-- JSON files -->
      <remove fileExtension=".json" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
      
      <!-- Data files -->
      <remove fileExtension=".dat" />
      <mimeMap fileExtension=".dat" mimeType="application/octet-stream" />
      
      <!-- Blazor files -->
      <remove fileExtension=".blat" />
      <mimeMap fileExtension=".blat" mimeType="application/octet-stream" />
    </staticContent>

    <!-- URL Rewrite for Brotli compression -->
    <rewrite>
      <outboundRules>
        <!-- Serve pre-compressed Brotli files for WASM -->
        <rule name="Serve Brotli WASM" enabled="true">
          <match serverVariable="RESPONSE_Content-Encoding" pattern=".*" />
          <conditions>
            <add input="{HTTP_ACCEPT_ENCODING}" pattern="br" />
            <add input="{REQUEST_FILENAME}" pattern="\.wasm$" />
            <add input="{REQUEST_FILENAME}.br" matchType="IsFile" />
          </conditions>
          <action type="Rewrite" value="br" />
        </rule>
        
        <!-- Serve pre-compressed Brotli files for JS -->
        <rule name="Serve Brotli JS" enabled="true">
          <match serverVariable="RESPONSE_Content-Encoding" pattern=".*" />
          <conditions>
            <add input="{HTTP_ACCEPT_ENCODING}" pattern="br" />
            <add input="{REQUEST_FILENAME}" pattern="\.js$" />
            <add input="{REQUEST_FILENAME}.br" matchType="IsFile" />
          </conditions>
          <action type="Rewrite" value="br" />
        </rule>
        
        <!-- Fallback to Gzip if Brotli not supported -->
        <rule name="Serve Gzip" enabled="true" stopProcessing="true">
          <match serverVariable="RESPONSE_Content-Encoding" pattern=".*" />
          <conditions>
            <add input="{HTTP_ACCEPT_ENCODING}" pattern="gzip" />
            <add input="{REQUEST_FILENAME}" pattern="\.(wasm|js|css)$" />
            <add input="{REQUEST_FILENAME}.gz" matchType="IsFile" />
          </conditions>
          <action type="Rewrite" value="gzip" />
        </rule>
      </outboundRules>
      
      <rules>
        <!-- Serve .br files directly when requested -->
        <rule name="Rewrite Brotli WASM" stopProcessing="true">
          <match url="(.*)\.wasm$" />
          <conditions>
            <add input="{HTTP_ACCEPT_ENCODING}" pattern="br" />
            <add input="{REQUEST_FILENAME}.br" matchType="IsFile" />
          </conditions>
          <action type="Rewrite" url="{R:1}.wasm.br" />
        </rule>
        
        <rule name="Rewrite Brotli JS" stopProcessing="true">
          <match url="(.*)\.js$" />
          <conditions>
            <add input="{HTTP_ACCEPT_ENCODING}" pattern="br" />
            <add input="{REQUEST_FILENAME}.br" matchType="IsFile" />
          </conditions>
          <action type="Rewrite" url="{R:1}.js.br" />
        </rule>
        
        <!-- Fallback to gzip -->
        <rule name="Rewrite Gzip WASM" stopProcessing="true">
          <match url="(.*)\.wasm$" />
          <conditions>
            <add input="{HTTP_ACCEPT_ENCODING}" pattern="gzip" />
            <add input="{REQUEST_FILENAME}.gz" matchType="IsFile" />
          </conditions>
          <action type="Rewrite" url="{R:1}.wasm.gz" />
        </rule>
      </rules>
    </rewrite>

    <!-- Caching for optimal performance -->
    <staticContent>
      <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="365.00:00:00" />
    </staticContent>

    <!-- Custom headers for Brotli -->
    <httpProtocol>
      <customHeaders>
        <add name="Vary" value="Accept-Encoding" />
      </customHeaders>
    </httpProtocol>

    <!-- Enable HTTP/2 for better performance -->
    <httpProtocol>
      <customHeaders>
        <add name="X-Content-Type-Options" value="nosniff" />
      </customHeaders>
    </httpProtocol>
  </system.webServer>
</configuration>
